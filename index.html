<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Apuntes de Conta</title>
    <script src="https://cdn.tailwindcss.com?plugins=forms"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        /* Estilos adicionales si son necesarios */
        body {
            font-family: 'Inter', sans-serif; /* Fuente Inter */
            display: flex;
            flex-direction: column;
            min-height: 100vh;
            background-color: #f3f4f6; /* Gris claro de fondo */
        }
        main {
            flex-grow: 1;
        }
        /* Estilos para el modal */
        .modal {
            transition: opacity 0.3s ease, visibility 0.3s ease;
        }
        .modal-content {
            transition: transform 0.3s ease;
        }
        /* Clases para mostrar/ocultar modal */
        .modal-hidden {
            opacity: 0;
            visibility: hidden;
        }
        .modal-visible {
            opacity: 1;
            visibility: visible;
        }
        .modal-content-hidden {
            transform: scale(0.9);
        }
        .modal-content-visible {
            transform: scale(1);
        }
        /* Estilos para botones de acción en tabla */
        .action-button {
            @apply p-1 rounded hover:bg-gray-200 transition-colors duration-150;
        }
         /* Logo QRM */
        .logo-qrm {
            font-weight: bold;
            font-size: 1.5rem; /* Ajusta tamaño según necesites */
            letter-spacing: -1px;
            color: #4a5568; /* Color gris oscuro */
        }
        .logo-qrm span:nth-child(1) { color: #3b82f6; } /* Azul */
        .logo-qrm span:nth-child(2) { color: #10b981; } /* Verde */
        .logo-qrm span:nth-child(3) { color: #f59e0b; } /* Ámbar */

        /* Asegurar que Lucide Icons se rendericen */
        [data-lucide] {
             display: inline-block;
             width: 1em;
             height: 1em;
             vertical-align: -0.125em;
        }
    </style>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
</head>
<body class="bg-gray-100">

    <header class="bg-white shadow-md sticky top-0 z-10">
        <div class="container mx-auto px-4 py-4 flex justify-between items-center">
            <div class="logo-qrm">
                <span>Q</span><span>R</span><span>M</span>
            </div>
            <h1 class="text-2xl font-bold text-gray-700">Apuntes de Conta</h1>
            <div></div>
        </div>
    </header>

    <main class="container mx-auto px-4 py-8">
        <div class="flex justify-end mb-6">
            <button id="addNoteBtn" class="bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-4 rounded-lg shadow flex items-center transition duration-150 ease-in-out">
                <i data-lucide="plus" class="mr-2"></i> Añadir Apunte
            </button>
        </div>

        <div class="bg-white rounded-lg shadow overflow-x-auto">
            <table class="min-w-full divide-y divide-gray-200">
                <thead class="bg-gray-50">
                    <tr>
                        <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Fecha</th>
                        <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Concepto</th>
                        <th scope="col" class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">Monto (€)</th>
                        <th scope="col" class="px-6 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider">Acciones</th>
                    </tr>
                </thead>
                <tbody id="notesTableBody" class="bg-white divide-y divide-gray-200">
                    <tr id="no-notes-row" class="hidden">
                        <td colspan="4" class="px-6 py-4 whitespace-nowrap text-sm text-gray-500 text-center">No hay apuntes todavía.</td>
                    </tr>
                </tbody>
                 <tfoot class="bg-gray-50">
                    <tr>
                        <td colspan="2" class="px-6 py-3 text-right text-sm font-medium text-gray-700">Total:</td>
                        <td id="totalAmount" class="px-6 py-3 text-right text-sm font-semibold text-gray-900">0.00 €</td>
                        <td class="px-6 py-3"></td> </tr>
                </tfoot>
            </table>
        </div>
    </main>

    <footer class="bg-gray-800 text-gray-300 mt-auto">
        <div class="container mx-auto px-4 py-4 flex flex-col sm:flex-row justify-between items-center text-sm">
             <div class="logo-qrm mb-2 sm:mb-0">
                <span>Q</span><span>R</span><span>M</span>
            </div>
            <p>&copy; <span id="currentYear"></span> Quira Media. Todos los derechos reservados.</p>
        </div>
    </footer>

    <div id="noteModal" class="modal modal-hidden fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full flex items-center justify-center z-50 px-4">
        <div class="modal-content modal-content-hidden bg-white p-6 md:p-8 rounded-lg shadow-xl w-full max-w-md transform">
            <h2 id="modalTitle" class="text-xl font-semibold mb-6 text-gray-800">Añadir Nuevo Apunte</h2>
            <form id="noteForm">
                <input type="hidden" id="noteId"> <div class="mb-4">
                    <label for="fecha" class="block text-sm font-medium text-gray-700 mb-1">Fecha</label>
                    <input type="date" id="fecha" name="fecha" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm" required>
                </div>
                <div class="mb-4">
                    <label for="concepto" class="block text-sm font-medium text-gray-700 mb-1">Concepto</label>
                    <input type="text" id="concepto" name="concepto" placeholder="Ej: Compra de material" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm" required>
                </div>
                <div class="mb-6">
                    <label for="monto" class="block text-sm font-medium text-gray-700 mb-1">Monto (€)</label>
                    <input type="number" id="monto" name="monto" step="0.01" placeholder="Ej: 150.50" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm" required>
                </div>
                <div class="flex justify-end space-x-3">
                    <button type="button" id="cancelBtn" class="bg-gray-300 hover:bg-gray-400 text-gray-800 font-bold py-2 px-4 rounded-lg transition duration-150 ease-in-out">
                        Cancelar
                    </button>
                    <button type="submit" id="saveBtn" class="bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-4 rounded-lg transition duration-150 ease-in-out">
                        Guardar
                    </button>
                </div>
            </form>
        </div>
    </div>

    <script>
        // --- Elementos del DOM ---
        const addNoteBtn = document.getElementById('addNoteBtn');
        const noteModal = document.getElementById('noteModal');
        const modalContent = noteModal.querySelector('.modal-content');
        const cancelBtn = document.getElementById('cancelBtn');
        const noteForm = document.getElementById('noteForm');
        const modalTitle = document.getElementById('modalTitle');
        const notesTableBody = document.getElementById('notesTableBody');
        const noNotesRow = document.getElementById('no-notes-row');
        const totalAmountCell = document.getElementById('totalAmount');
        const currentYearSpan = document.getElementById('currentYear');
        const noteIdInput = document.getElementById('noteId');
        const fechaInput = document.getElementById('fecha');
        const conceptoInput = document.getElementById('concepto');
        const montoInput = document.getElementById('monto');

        // --- Estado de la Aplicación ---
        let notes = []; // Array para almacenar los apuntes
        let editingNoteId = null; // Para saber si estamos editando

        // --- Funciones ---

        // Obtener apuntes del localStorage
        function loadNotes() {
            const storedNotes = localStorage.getItem('accountingNotes');
            notes = storedNotes ? JSON.parse(storedNotes) : [];
            renderNotes();
            // Renderizar iconos Lucide después de cargar notas
            if (window.lucide) {
                lucide.createIcons();
            }
        }

        // Guardar apuntes en localStorage
        function saveNotes() {
            localStorage.setItem('accountingNotes', JSON.stringify(notes));
            renderNotes(); // Volver a renderizar la tabla después de guardar
             // Renderizar iconos Lucide después de guardar/actualizar notas
            if (window.lucide) {
                lucide.createIcons();
            }
        }

        // Formatear moneda
        function formatCurrency(amount) {
            return new Intl.NumberFormat('es-ES', { style: 'currency', currency: 'EUR' }).format(amount);
        }

        // Calcular y mostrar total
        function calculateTotal() {
            const total = notes.reduce((sum, note) => sum + parseFloat(note.monto || 0), 0);
            totalAmountCell.textContent = formatCurrency(total);
        }

        // Renderizar la tabla de apuntes
        function renderNotes() {
            notesTableBody.innerHTML = ''; // Limpiar tabla existente

            if (notes.length === 0) {
                noNotesRow.classList.remove('hidden'); // Mostrar mensaje si no hay notas
            } else {
                noNotesRow.classList.add('hidden'); // Ocultar mensaje
                notes.forEach(note => {
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${note.fecha}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-700">${note.concepto}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-700 text-right">${formatCurrency(note.monto)}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-center">
                            <button class="action-button edit-btn text-blue-600 hover:text-blue-800" data-id="${note.id}" title="Editar">
                                <i data-lucide="edit-2" class="w-4 h-4"></i>
                            </button>
                            <button class="action-button delete-btn text-red-600 hover:text-red-800" data-id="${note.id}" title="Borrar">
                                <i data-lucide="trash-2" class="w-4 h-4"></i>
                            </button>
                        </td>
                    `;
                    notesTableBody.appendChild(row);
                });
            }
            calculateTotal(); // Recalcular total cada vez que se renderiza

             // Añadir event listeners a los nuevos botones de editar/borrar
            addTableButtonListeners();
        }

        // Añadir listeners a botones de la tabla
        function addTableButtonListeners() {
            document.querySelectorAll('.edit-btn').forEach(button => {
                button.addEventListener('click', handleEditNote);
            });
            document.querySelectorAll('.delete-btn').forEach(button => {
                button.addEventListener('click', handleDeleteNote);
            });
        }

        // Mostrar el modal
        function showModal(isEditing = false, noteData = null) {
            editingNoteId = isEditing ? noteData.id : null; // Guardar ID si estamos editando
            modalTitle.textContent = isEditing ? 'Editar Apunte' : 'Añadir Nuevo Apunte';

            if (isEditing && noteData) {
                noteIdInput.value = noteData.id;
                fechaInput.value = noteData.fecha;
                conceptoInput.value = noteData.concepto;
                montoInput.value = noteData.monto;
            } else {
                noteForm.reset(); // Limpiar formulario para nuevo apunte
                noteIdInput.value = ''; // Asegurarse que el ID oculto está vacío
                 // Poner fecha actual por defecto
                fechaInput.valueAsDate = new Date();
            }

            noteModal.classList.remove('modal-hidden');
            noteModal.classList.add('modal-visible');
            modalContent.classList.remove('modal-content-hidden');
            modalContent.classList.add('modal-content-visible');
             // Renderizar iconos Lucide en el modal si es necesario (aunque no hay en este modal)
            if (window.lucide) {
                lucide.createIcons();
            }
        }

        // Ocultar el modal
        function hideModal() {
            noteModal.classList.add('modal-hidden');
            noteModal.classList.remove('modal-visible');
            modalContent.classList.add('modal-content-hidden');
            modalContent.classList.remove('modal-content-visible');
            noteForm.reset(); // Limpiar formulario al cerrar
            editingNoteId = null; // Resetear ID de edición
            noteIdInput.value = '';
        }

        // Manejar envío del formulario (Guardar/Actualizar)
        function handleFormSubmit(event) {
            event.preventDefault(); // Evitar recarga de página

            const formData = {
                id: noteIdInput.value || Date.now().toString(), // Usar ID existente o crear uno nuevo
                fecha: fechaInput.value,
                concepto: conceptoInput.value.trim(),
                monto: parseFloat(montoInput.value) || 0
            };

            if (!formData.fecha || !formData.concepto) {
                // Aquí podrías añadir una validación más robusta o feedback al usuario
                console.error("Fecha y concepto son requeridos.");
                return;
            }

            if (editingNoteId) {
                // Actualizar apunte existente
                const noteIndex = notes.findIndex(note => note.id === editingNoteId);
                if (noteIndex > -1) {
                    notes[noteIndex] = formData;
                }
            } else {
                // Añadir nuevo apunte
                notes.push(formData);
            }

            saveNotes(); // Guardar en localStorage y re-renderizar
            hideModal(); // Ocultar modal
        }

        // Manejar clic en botón Editar
        function handleEditNote(event) {
            const button = event.currentTarget;
            const id = button.dataset.id;
            const noteToEdit = notes.find(note => note.id === id);
            if (noteToEdit) {
                showModal(true, noteToEdit); // Mostrar modal en modo edición
            }
        }

        // Manejar clic en botón Borrar
        function handleDeleteNote(event) {
            const button = event.currentTarget;
            const id = button.dataset.id;
             // Confirmación antes de borrar
             if (confirm('¿Estás seguro de que quieres borrar este apunte?')) {
                notes = notes.filter(note => note.id !== id); // Filtrar el array
                saveNotes(); // Guardar cambios y re-renderizar
            }
        }

        // --- Inicialización y Event Listeners ---

        // Listener para abrir modal
        addNoteBtn.addEventListener('click', () => showModal(false));

        // Listener para cerrar modal con botón Cancelar
        cancelBtn.addEventListener('click', hideModal);

        // Listener para cerrar modal haciendo clic fuera del contenido
        noteModal.addEventListener('click', (event) => {
            if (event.target === noteModal) { // Si se hizo clic en el fondo oscuro
                hideModal();
            }
        });

        // Listener para el envío del formulario
        noteForm.addEventListener('submit', handleFormSubmit);

        // Poner año actual en el footer
        currentYearSpan.textContent = new Date().getFullYear();

        // Cargar apuntes al iniciar la página
        document.addEventListener('DOMContentLoaded', () => {
            loadNotes();
            // Inicializar Lucide Icons al cargar el DOM
            if (window.lucide) {
                lucide.createIcons();
            } else {
                console.warn("Lucide Icons script not loaded yet.");
                // Intentar inicializar de nuevo tras un pequeño retraso
                 setTimeout(() => {
                    if (window.lucide) {
                       lucide.createIcons();
                    } else {
                       console.error("Failed to load Lucide Icons script.");
                    }
                }, 500);
            }
        });

    </script>
</body>
</html>
